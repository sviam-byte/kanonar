import React from 'react';

const Chapter: React.FC<{id: string, title: string; children: React.ReactNode}> = ({id, title, children}) => (
    <section id={id} className="pt-6 mt-6 border-t border-canon-border scroll-mt-20 first:border-t-0 first:pt-0 first:mt-0">
        <h2 className="text-2xl font-bold text-canon-text mb-4">{title}</h2>
        <div className="space-y-4">{children}</div>
    </section>
);

const Section: React.FC<{id: string, title: string; children: React.ReactNode}> = ({id, title, children}) => (
    <div id={id} className="pt-4 mt-4 border-t border-canon-border/50 scroll-mt-20">
        <h3 className="text-xl font-bold text-canon-accent mb-3">{title}</h3>
        <div className="space-y-3">{children}</div>
    </div>
);

const Formula: React.FC<{ children: React.ReactNode; title?: string }> = ({ children, title }) => (
    <>
        {title && <p className="mt-2 text-sm text-canon-text font-semibold">{title}</p>}
        <pre className="bg-canon-bg text-xs p-3 rounded mt-1 font-mono overflow-x-auto"><code>
            {children}
        </code></pre>
    </>
);

export const EventsAndGoalsReference: React.FC = () => {
    return (
        <div className="text-canon-text-light text-sm leading-relaxed">
            <Chapter id="intro" title="Обзор: Двигатель и Руль">
                <p>Система событий и целей — это ядро динамической модели Kanonar 4.0. Она описывает, как персонажи меняются под воздействием внешнего мира и внутренних мотивов.</p>
                <ul className="list-disc pl-5 space-y-2">
                    <li><strong>События — это «Двигатель»</strong>: Они являются основным источником изменений. Событие — это любой факт из прошлого или настоящего, который оказывает влияние на персонажа. Они могут быть личными (травма, достижение) или социальными (конфликт, союз). События — это то, что «случается» с персонажем.</li>
                    <li><strong>Цели — это «Руль»</strong>: Они определяют, как персонаж реагирует на изменения и куда он направляет свои усилия. Цели динамически активируются в ответ на текущее состояние персонажа и произошедшие события. Цели — это то, что персонаж «делает» или «хочет сделать».</li>
                </ul>
                <p>Эти две системы образуют непрерывный цикл обратной связи: <strong>События → Изменение состояния → Активация целей → Действия → Новые события</strong>.</p>
            </Chapter>

            <Chapter id="events-pipeline" title="Конвейер Влияния Событий">
                <p>Каждое событие, добавленное в историю персонажа, проходит через конвейер, который рассчитывает его влияние на все аспекты модели.</p>
                <Section id="personal-events" title="1. Личные События">
                    <p>Это события, касающиеся непосредственно персонажа. Они создаются вручную на странице персонажа или генерируются как результат выполнения цели.</p>
                    <p><strong>Шаг 1.1: Расчет Веса События (Wₑ)</strong></p>
                    <p>Не все события одинаково важны. Вес события определяет силу его долгосрочного влияния. Он зависит от множества факторов:</p>
                    <Formula>Wₑ = intensity · |valence| · w_rec · w_imprint · w_chron · (1 + 0.2·w_reh)</Formula>
                    <ul className="list-disc pl-5 text-xs space-y-1">
                        <li><code>intensity</code>: Интенсивность (0-1).</li>
                        <li><code>valence</code>: Полярность (-1 до +1), положительное или отрицательное.</li>
                        <li><code>w_rec</code>: Давность (recency). События из недавнего прошлого важнее. Экспоненциально затухает.</li>
                        <li><code>w_imprint</code>: "Импринтинг". События, произошедшие в критические периоды жизни (детство, юность), имеют больший вес.</li>
                        <li><code>w_chron</code>: Хроничность. Длительные события оказывают большее влияние.</li>
                        <li><code>w_reh</code>: Повторение (rehearsal). Часто вспоминаемые события закрепляются в памяти.</li>
                    </ul>
                    <p><strong>Шаг 1.2: Долгосрочные Сдвиги («Движение ползунков»)</strong></p>
                    <p>Вес события (Wₑ) используется для **перманентного** изменения базовых параметров персонажа в его `vector_base`. Это и есть эффект «движения ползунков». Например, публичный провал (valence &lt; 0) с высоким Wₑ может немного, но навсегда снизить `G_Self_concept_strength`.</p>
                    <Formula title="Пример сдвига">x' = x + κₑ · sign(valence) · Wₑ</Formula>
                    <p><strong>Шаг 1.3: Острые Импульсы</strong></p>
                    <p>События вызывают немедленную реакцию в остром состоянии персонажа. Эти импульсы не являются постоянными и со временем затухают.</p>
                    <Formula title="ΔStress ∝ surprise + (1 - controllability)">ΔFatigue ∝ √duration_days</Formula>
                    <p><strong>Шаг 1.4: Импульсы к Целям (ω-карты)</strong></p>
                    <p>Каждое событие несет в себе «ω-карту» — набор импульсов, которые повышают или понижают активационный скор релевантных целей. Например, событие `INJURY_MAJOR` дает сильный положительный импульс цели `SEEK_MEDICAL_AID`.</p>
                    <Formula>Sₒ(g) ← Sₒ(g) + ωₒ(e) · valence · intensity · decay(Δt)</Formula>
                </Section>

                <Section id="social-events" title="2. Социальные События">
                    <p>Это события, описывающие взаимодействие между двумя или более персонажами. Они создаются в разделе «Соц. События».</p>
                    <p><strong>Шаг 2.1: Авто-зеркалирование и Влияние на Цель</strong></p>
                    <p>Любое событие (Актор → Цель) автоматически создает «зеркальное» событие для Цели. На основе полярности, интенсивности и параметров Цели (например, `C_reciprocity_index`), у нее генерируется **острый импульс стресса**.</p>
                    <p><strong>Шаг 2.2: Обновление Отношений Актора</strong></p>
                    <p>У Актора обновляются его динамические социальные связи с Целью:</p>
                    <ul className="list-disc pl-5 space-y-1">
                        <li><strong>Ledger (Кредит отношений):</strong> Положительные действия увеличивают «кредит», отрицательные — уменьшают.</li>
                        <li><strong>Trust (Доверие):</strong> Доверие меняется в зависимости от события, с большим штрафом за предательство.</li>
                    </ul>
                    <p>Эти параметры видны на вкладке «Социальные связи» на странице персонажа.</p>
                </Section>
            </Chapter>

            <Chapter id="goals-ecology" title="Экология Целей">
                <p>Экология целей — это система, которая на основе текущего состояния персонажа и импульсов от событий определяет, какие цели являются для него наиболее актуальными.</p>
                <Section id="goal-activation" title="1. Активация">
                    <p>Для каждой цели из глобального каталога рассчитывается **Активационный Скор (Sₒ)**.</p>
                    <Formula>Sₒ(g) = base + Σ (param_value * weight) + Σ (event_impulse)</Formula>
                    <p>Если `Sₒ(g)` превышает порог активации цели и все ее «гейты» (условия, например, `clearance_level &gt;= 3`) пройдены, цель становится **активной**.</p>
                </Section>
                <Section id="goal-arbitration" title="2. Арбитраж">
                    <p>Активные цели проходят через процесс арбитража, чтобы разрешить конфликты.</p>
                    <ul className="list-disc pl-5 space-y-2">
                        <li><strong>Расчет Приоритета:</strong> Каждая цель получает приоритет на основе ее выгоды, соответствия клятвам (деонтологический фит) и внешних эффектов (конфликтов с другими целями).</li>
                        <li><strong>Сортировка:</strong> Цели сортируются на три группы:
                            <ul className="list-['-_'] pl-4 mt-1">
                                <li><strong>Execute:</strong> Цели с наивысшим приоритетом, не конфликтующие друг с другом. Готовы к выполнению.</li>
                                <li><strong>Queue:</strong> Цели с высоким приоритетом, но конфликтующие с теми, что в `Execute`. Ждут своей очереди.</li>
                                <li><strong>Drop:</strong> Цели с низким приоритетом или нарушающие табу. Отбрасываются.</li>
                            </ul>
                        </li>
                    </ul>
                </Section>
                <Section id="goal-frustration" title="3. Фрустрация и Напряжение">
                    <p><strong>Напряжение (Tension)</strong> — это мера общего конфликта в системе, сумма произведений весов всех конфликтующих пар целей. <strong>Фрустрация (Frustration)</strong> — это сумма весов всех заблокированных (`Queue`) или отброшенных (`Drop`) целей. Высокая фрустрация замыкает порочный круг:</p>
                    <Formula>ΔStress ∝ Frustration</Formula>
                    <Formula>ΔDQ ∝ -Frustration</Formula>
                </Section>
            </Chapter>
            
            <Chapter id="closing-the-loop" title="Замыкание Цикла">
                <Section id="goal-execution" title="1. Выполнение Цели">
                    <p>При нажатии кнопки «Выполнить цель» запускается симуляция ее исхода.</p>
                    <p><strong>Шаг 1: Расчет Исполнимости (Fₒ)</strong></p>
                    <p>Насколько персонаж способен выполнить эту цель. Зависит от его навыков, качества решений (DQ), рабочей памяти (WMcap) и рисков.</p>
                    <Formula>Fₒ = σ(β₁·DQ + β₂·WMcap + β₃·SD + β₄·skill_match - ...)</Formula>
                    <p><strong>Шаг 2: Расчет Вероятности Успеха (P_succ)</strong></p>
                    <p>Итоговая вероятность успеха, которая учитывает исполнимость и штрафы за нарушение клятв или гейтов.</p>
                    <Formula>P_succ(g) = σ(θ₀ + θ₁·Fₒ - θ₂·gate_penalty - θ₃·oath_friction)</Formula>
                </Section>
                <Section id="outcome-as-event" title="2. Исход как Событие">
                    <p>На основе `P_succ` генерируется случайный исход:</p>
                    <ul className="list-disc pl-5 space-y-1">
                        <li><strong>Успех:</strong> Создается новое личное событие `GOAL.SUCCESS`.</li>
                        <li><strong>Провал:</strong> Создается событие `GOAL.FAIL`. При провале также рассчитывается **риск каскадного сбоя (`P_surge`)**. Если он срабатывает, создается более тяжелое событие `GOAL.FAIL.SURGE`.</li>
                    </ul>
                    <p>Это новое событие **добавляется в историю персонажа** и на следующем же тике проходит через весь конвейер влияния, замыкая цикл обратной связи.</p>
                </Section>
            </Chapter>
            
            <Chapter id="link-to-stability" title="Связь со Стабильностью (SDE)">
                 <p>Система событий и целей напрямую и неразрывно связана с моделью симуляции стабильности (SDE).</p>
                 <ul className="list-disc pl-5 space-y-2">
                    <li><strong>Острые состояния → Разрушитель (h):</strong> Острые состояния, такие как <strong>Стресс</strong> и <strong>Усталость</strong>, являются прямыми компонентами в формуле расчета «разрушителя» `h`. Любое событие или высокий уровень фрустрации, повышающие стресс, **немедленно увеличивают `h`**, что тянет прогноз стабильности и стационарную точку `S*` вниз.</li>
                    <li><strong>Долгосрочные сдвиги → Латенты → Параметры SDE:</strong> Долгосрочные сдвиги базовых параметров от событий изменяют латенты (CH, SD и др.). Эти латенты, в свою очередь, влияют на все параметры SDE: `μ` (цель), `κ` (жесткость) и `h` (разрушитель), меняя долгосрочную траекторию стабильности.</li>
                 </ul>
                 <Formula>h ∝ σ(Vσ + DS + C_causal + Stress + Fatigue)</Formula>
            </Chapter>
        </div>
    );
}